@inherits LayoutComponentBase
@inject ISettingsService SettingsService

<MudThemeProvider @ref="_themeProvider" @bind-IsDarkMode="_isDarkMode" />
<MudPopoverProvider />
<MudDialogProvider />
<MudSnackbarProvider />

<MudLayout>
    <MudAppBar Elevation="1">
        <MudText Typo="Typo.h6">Desktop Features Demo</MudText>
        <MudSpacer />
        <MudTooltip Text="@(_isDarkMode ? "Switch to Light Mode" : "Switch to Dark Mode")">
            <MudIconButton Icon="@(_isDarkMode ? Icons.Material.Filled.LightMode : Icons.Material.Filled.DarkMode)"
                           Color="Color.Inherit"
                           OnClick="ToggleDarkMode" />
        </MudTooltip>
    </MudAppBar>
    <MudMainContent Class="pa-4">
        @Body
    </MudMainContent>
</MudLayout>

@code {
    private MudThemeProvider? _themeProvider;
    private bool _isDarkMode;

    protected override async Task OnInitializedAsync()
    {
        var appSettings = await SettingsService.GetSectionAsync<DesktopFeatures.Models.AppSettings>();
        _isDarkMode = appSettings.IsDarkMode;
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender && _themeProvider is not null)
        {
            var appSettings = await SettingsService.GetSectionAsync<DesktopFeatures.Models.AppSettings>();
            _isDarkMode = appSettings.IsDarkMode;
            StateHasChanged();
        }
    }

    private async Task ToggleDarkMode()
    {
        _isDarkMode = !_isDarkMode;
        await SettingsService.UpdateSectionAsync<DesktopFeatures.Models.AppSettings>(s => s.IsDarkMode = _isDarkMode);
    }
}
