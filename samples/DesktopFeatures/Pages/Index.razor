@page "/"
@inject IDesktopInteropService DesktopInterop
@inject ISystemTrayService TrayService
@inject INotificationService NotificationService
@inject IJSRuntime JSRuntime
@inject SettingsService SettingsService
@inject ISnackbar Snackbar

<MudText Typo="Typo.h4" Class="mb-4">Desktop Features Demo</MudText>
<MudText Typo="Typo.body1" Class="mb-6">
    Demonstrates native desktop capabilities provided by CheapAvaloniaBlazor.
</MudText>

<MudGrid>
    <MudItem xs="12" md="6">
        <MudPaper Class="pa-4" Elevation="2">
            <MudText Typo="Typo.h6" Class="mb-3">File Dialogs</MudText>

            <MudStack Spacing="2">
                <MudButton Variant="Variant.Filled"
                           Color="Color.Primary"
                           StartIcon="@Icons.Material.Filled.FolderOpen"
                           OnClick="OpenFile">
                    Open File
                </MudButton>

                <MudButton Variant="Variant.Filled"
                           Color="Color.Secondary"
                           StartIcon="@Icons.Material.Filled.Save"
                           OnClick="SaveFile">
                    Save File
                </MudButton>

                <MudButton Variant="Variant.Filled"
                           Color="Color.Tertiary"
                           StartIcon="@Icons.Material.Filled.Folder"
                           OnClick="OpenFolder">
                    Open Folder
                </MudButton>

                @if (!string.IsNullOrEmpty(_selectedPath))
                {
                    <MudAlert Severity="Severity.Info" Class="mt-2">
                        <MudText Typo="Typo.body2">@_selectedPath</MudText>
                    </MudAlert>
                }
            </MudStack>
        </MudPaper>
    </MudItem>

    <MudItem xs="12" md="6">
        <MudPaper Class="pa-4" Elevation="2">
            <MudText Typo="Typo.h6" Class="mb-3">Window Controls</MudText>

            <MudStack Spacing="2">
                <MudButton Variant="Variant.Outlined"
                           StartIcon="@Icons.Material.Filled.Minimize"
                           OnClick="@(() => DesktopInterop.MinimizeWindowAsync())">
                    Minimize
                </MudButton>

                <MudButton Variant="Variant.Outlined"
                           StartIcon="@Icons.Material.Filled.Fullscreen"
                           OnClick="@(() => DesktopInterop.MaximizeWindowAsync())">
                    Maximize
                </MudButton>

                <MudButton Variant="Variant.Outlined"
                           StartIcon="@Icons.Material.Filled.FullscreenExit"
                           OnClick="@(() => DesktopInterop.RestoreWindowAsync())">
                    Restore
                </MudButton>

                <MudTextField @bind-Value="_windowTitle"
                              Label="Window Title"
                              Variant="Variant.Outlined"
                              Adornment="Adornment.End"
                              AdornmentIcon="@Icons.Material.Filled.Edit"
                              OnAdornmentClick="SetWindowTitle" />
            </MudStack>
        </MudPaper>
    </MudItem>

    <MudItem xs="12" md="6">
        <MudPaper Class="pa-4" Elevation="2">
            <MudText Typo="Typo.h6" Class="mb-3">Clipboard</MudText>

            <MudStack Spacing="2">
                <MudTextField @bind-Value="_clipboardText"
                              Label="Clipboard Text"
                              Variant="Variant.Outlined"
                              Lines="3" />

                <MudButtonGroup Variant="Variant.Outlined">
                    <MudButton StartIcon="@Icons.Material.Filled.ContentCopy"
                               OnClick="CopyToClipboard">
                        Copy
                    </MudButton>
                    <MudButton StartIcon="@Icons.Material.Filled.ContentPaste"
                               OnClick="PasteFromClipboard">
                        Paste
                    </MudButton>
                </MudButtonGroup>
            </MudStack>
        </MudPaper>
    </MudItem>

    <MudItem xs="12" md="6">
        <MudPaper Class="pa-4" Elevation="2">
            <MudText Typo="Typo.h6" Class="mb-3">System</MudText>

            <MudStack Spacing="2">
                <MudButton Variant="Variant.Outlined"
                           StartIcon="@Icons.Material.Filled.OpenInBrowser"
                           OnClick="@(() => DesktopInterop.OpenUrlInBrowserAsync("https://github.com/CheapNud/CheapAvaloniaBlazor"))">
                    Open GitHub
                </MudButton>

                <MudButton Variant="Variant.Outlined"
                           StartIcon="@Icons.Material.Filled.Folder"
                           OnClick="ShowAppDataPath">
                    Show AppData Path
                </MudButton>

                <MudButton Variant="Variant.Outlined"
                           StartIcon="@Icons.Material.Filled.Description"
                           OnClick="ShowDocumentsPath">
                    Show Documents Path
                </MudButton>
            </MudStack>
        </MudPaper>
    </MudItem>

    <MudItem xs="12" md="6">
        <MudPaper Class="pa-4" Elevation="2">
            <MudText Typo="Typo.h6" Class="mb-3">System Tray</MudText>

            <MudStack Spacing="2">
                <MudButton Variant="Variant.Filled"
                           Color="Color.Primary"
                           StartIcon="@Icons.Material.Filled.NotificationsActive"
                           OnClick="MinimizeToTray">
                    Minimize to Tray
                </MudButton>

                <MudButton Variant="Variant.Outlined"
                           StartIcon="@(_trayVisible ? Icons.Material.Filled.Visibility : Icons.Material.Filled.VisibilityOff)"
                           OnClick="ToggleTrayIcon">
                    @(_trayVisible ? "Hide Tray Icon" : "Show Tray Icon")
                </MudButton>

                <MudTextField @bind-Value="_trayTooltip"
                              Label="Tray Tooltip"
                              Variant="Variant.Outlined"
                              Adornment="Adornment.End"
                              AdornmentIcon="@Icons.Material.Filled.Edit"
                              OnAdornmentClick="SetTrayTooltip" />

                <MudButton Variant="Variant.Outlined"
                           StartIcon="@Icons.Material.Filled.Add"
                           OnClick="AddCustomTrayMenuItem">
                    Add Custom Menu Item
                </MudButton>

                <MudButton Variant="Variant.Outlined"
                           Color="Color.Warning"
                           StartIcon="@Icons.Material.Filled.Clear"
                           OnClick="ClearCustomTrayMenuItems">
                    Clear Custom Items
                </MudButton>

                <MudAlert Severity="Severity.Info" Dense="true" Class="mt-2">
                    <MudText Typo="Typo.caption">
                        Close button minimizes to tray. Right-click tray icon for menu.
                    </MudText>
                </MudAlert>
            </MudStack>
        </MudPaper>
    </MudItem>

    <MudItem xs="12" md="6">
        <MudPaper Class="pa-4" Elevation="2">
            <MudText Typo="Typo.h6" Class="mb-3">Desktop Notifications</MudText>

            <MudStack Spacing="2">
                <MudTextField @bind-Value="_desktopNotificationTitle"
                              Label="Title"
                              Variant="Variant.Outlined" />

                <MudTextField @bind-Value="_desktopNotificationMessage"
                              Label="Message"
                              Variant="Variant.Outlined"
                              Lines="2" />

                <MudSelect T="CheapAvaloniaBlazor.Models.NotificationType"
                           @bind-Value="_desktopNotificationType"
                           Label="Type"
                           Variant="Variant.Outlined">
                    <MudSelectItem T="CheapAvaloniaBlazor.Models.NotificationType" Value="CheapAvaloniaBlazor.Models.NotificationType.Information">Information</MudSelectItem>
                    <MudSelectItem T="CheapAvaloniaBlazor.Models.NotificationType" Value="CheapAvaloniaBlazor.Models.NotificationType.Success">Success</MudSelectItem>
                    <MudSelectItem T="CheapAvaloniaBlazor.Models.NotificationType" Value="CheapAvaloniaBlazor.Models.NotificationType.Warning">Warning</MudSelectItem>
                    <MudSelectItem T="CheapAvaloniaBlazor.Models.NotificationType" Value="CheapAvaloniaBlazor.Models.NotificationType.Error">Error</MudSelectItem>
                </MudSelect>

                <MudButton Variant="Variant.Filled"
                           Color="Color.Primary"
                           StartIcon="@Icons.Material.Filled.DesktopWindows"
                           OnClick="SendDesktopNotification">
                    Send Desktop Toast
                </MudButton>

                <MudAlert Severity="Severity.Info" Dense="true" Class="mt-2">
                    <MudText Typo="Typo.caption">
                        Avalonia-rendered toast overlay. Cross-platform, always works, styled by notification type.
                    </MudText>
                </MudAlert>
            </MudStack>
        </MudPaper>
    </MudItem>

    <MudItem xs="12" md="6">
        <MudPaper Class="pa-4" Elevation="2">
            <MudText Typo="Typo.h6" Class="mb-3">System Notifications</MudText>

            <MudStack Spacing="2">
                <MudTextField @bind-Value="_systemNotificationTitle"
                              Label="Title"
                              Variant="Variant.Outlined" />

                <MudTextField @bind-Value="_systemNotificationMessage"
                              Label="Message"
                              Variant="Variant.Outlined"
                              Lines="2" />

                <MudButton Variant="Variant.Filled"
                           Color="Color.Secondary"
                           StartIcon="@Icons.Material.Filled.Notifications"
                           OnClick="SendSystemNotification"
                           Disabled="@(!NotificationService.SystemNotificationsEnabled)">
                    Send System Notification
                </MudButton>

                <MudAlert Severity="@(NotificationService.SystemNotificationsEnabled ? Severity.Info : Severity.Warning)" Dense="true" Class="mt-2">
                    <MudText Typo="Typo.caption">
                        @if (NotificationService.SystemNotificationsEnabled)
                        {
                            @:JS Web Notification API (OS notification center). Browser permission may be requested on first use.
                        }
                        else
                        {
                            @:System notifications are disabled. Enable via .EnableSystemNotifications() in Program.cs.
                        }
                    </MudText>
                </MudAlert>
            </MudStack>
        </MudPaper>
    </MudItem>

    <MudItem xs="12">
        <MudPaper Class="pa-4" Elevation="2">
            <MudText Typo="Typo.h6" Class="mb-3">Recent Files</MudText>

            @if (SettingsService.Settings.RecentFiles.Count == 0)
            {
                <MudText Typo="Typo.body2" Color="Color.Secondary">
                    No recent files. Use "Open File" to add some.
                </MudText>
            }
            else
            {
                <MudList T="string" Dense="true">
                    @foreach (var file in SettingsService.Settings.RecentFiles)
                    {
                        <MudListItem T="string" Icon="@Icons.Material.Filled.InsertDriveFile">
                            @file
                        </MudListItem>
                    }
                </MudList>

                <MudButton Variant="Variant.Text"
                           Color="Color.Error"
                           Size="Size.Small"
                           OnClick="ClearRecentFiles"
                           Class="mt-2">
                    Clear Recent Files
                </MudButton>
            }
        </MudPaper>
    </MudItem>
</MudGrid>

@code {
    private string? _selectedPath;
    private string _windowTitle = "Desktop Features Demo";
    private string _clipboardText = "";
    private string _trayTooltip = "Desktop Features Demo";
    private bool _trayVisible = true;
    private int _customMenuItemCount = 0;
    private string _desktopNotificationTitle = "Hello!";
    private string _desktopNotificationMessage = "This is a desktop toast from CheapAvaloniaBlazor.";
    private CheapAvaloniaBlazor.Models.NotificationType _desktopNotificationType = CheapAvaloniaBlazor.Models.NotificationType.Information;
    private string _systemNotificationTitle = "Hello!";
    private string _systemNotificationMessage = "This is a system notification from CheapAvaloniaBlazor.";

    private async Task OpenFile()
    {
        var options = new CheapAvaloniaBlazor.Models.FileDialogOptions
        {
            Title = "Select a file",
            Filters =
            [
                new CheapAvaloniaBlazor.Models.FileFilter { Name = "All Files", Extensions = ["*"] },
                new CheapAvaloniaBlazor.Models.FileFilter { Name = "Text Files", Extensions = ["txt", "md"] },
                new CheapAvaloniaBlazor.Models.FileFilter { Name = "Images", Extensions = ["png", "jpg", "jpeg", "gif"] }
            ]
        };

        _selectedPath = await DesktopInterop.OpenFileDialogAsync(options);

        if (!string.IsNullOrEmpty(_selectedPath))
        {
            await SettingsService.UpdateAsync(s => s.AddRecentFile(_selectedPath));
            Snackbar.Add($"Opened: {Path.GetFileName(_selectedPath)}", Severity.Success);
        }
    }

    private async Task SaveFile()
    {
        var options = new CheapAvaloniaBlazor.Models.FileDialogOptions
        {
            Title = "Save file as",
            DefaultFileName = "document.txt",
            Filters =
            [
                new CheapAvaloniaBlazor.Models.FileFilter { Name = "Text Files", Extensions = ["txt"] },
                new CheapAvaloniaBlazor.Models.FileFilter { Name = "All Files", Extensions = ["*"] }
            ]
        };

        _selectedPath = await DesktopInterop.SaveFileDialogAsync(options);

        if (!string.IsNullOrEmpty(_selectedPath))
        {
            await SettingsService.UpdateAsync(s => s.LastSavedFile = _selectedPath);
            Snackbar.Add($"Save location: {Path.GetFileName(_selectedPath)}", Severity.Success);
        }
    }

    private async Task OpenFolder()
    {
        _selectedPath = await DesktopInterop.OpenFolderDialogAsync();

        if (!string.IsNullOrEmpty(_selectedPath))
        {
            await SettingsService.UpdateAsync(s => s.LastOpenedFolder = _selectedPath);
            Snackbar.Add($"Selected folder: {_selectedPath}", Severity.Success);
        }
    }

    private async Task SetWindowTitle()
    {
        if (!string.IsNullOrWhiteSpace(_windowTitle))
        {
            await DesktopInterop.SetWindowTitleAsync(_windowTitle);
            Snackbar.Add("Window title updated", Severity.Info);
        }
    }

    private async Task CopyToClipboard()
    {
        if (!string.IsNullOrEmpty(_clipboardText))
        {
            await DesktopInterop.SetClipboardTextAsync(_clipboardText);
            Snackbar.Add("Copied to clipboard", Severity.Success);
        }
    }

    private async Task PasteFromClipboard()
    {
        var text = await DesktopInterop.GetClipboardTextAsync();
        if (text is not null)
        {
            _clipboardText = text;
            Snackbar.Add("Pasted from clipboard", Severity.Success);
        }
    }

    private async Task ShowAppDataPath()
    {
        var path = await DesktopInterop.GetAppDataPathAsync();
        Snackbar.Add($"AppData: {path}", Severity.Info);
    }

    private async Task ShowDocumentsPath()
    {
        var path = await DesktopInterop.GetDocumentsPathAsync();
        Snackbar.Add($"Documents: {path}", Severity.Info);
    }

    private async Task ClearRecentFiles()
    {
        await SettingsService.UpdateAsync(s => s.RecentFiles.Clear());
        Snackbar.Add("Recent files cleared", Severity.Warning);
    }

    private void SendDesktopNotification()
    {
        if (string.IsNullOrWhiteSpace(_desktopNotificationTitle))
        {
            Snackbar.Add("Notification title is required", Severity.Warning);
            return;
        }

        NotificationService.ShowDesktopNotification(
            _desktopNotificationTitle,
            _desktopNotificationMessage,
            _desktopNotificationType);
        Snackbar.Add("Desktop toast sent", Severity.Success);
    }

    private async Task SendSystemNotification()
    {
        if (string.IsNullOrWhiteSpace(_systemNotificationTitle))
        {
            Snackbar.Add("Notification title is required", Severity.Warning);
            return;
        }

        await NotificationService.ShowSystemNotificationAsync(JSRuntime, _systemNotificationTitle, _systemNotificationMessage);
        Snackbar.Add("System notification sent", Severity.Success);
    }

    private void MinimizeToTray()
    {
        TrayService.MinimizeToTray();
        Snackbar.Add("Minimized to tray - click tray icon to restore", Severity.Info);
    }

    private void ToggleTrayIcon()
    {
        if (_trayVisible)
        {
            TrayService.HideTrayIcon();
            _trayVisible = false;
            Snackbar.Add("Tray icon hidden", Severity.Warning);
        }
        else
        {
            TrayService.ShowTrayIcon();
            _trayVisible = true;
            Snackbar.Add("Tray icon shown", Severity.Success);
        }
    }

    private void SetTrayTooltip()
    {
        if (!string.IsNullOrWhiteSpace(_trayTooltip))
        {
            TrayService.SetTrayTooltip(_trayTooltip);
            Snackbar.Add("Tray tooltip updated", Severity.Info);
        }
    }

    private void AddCustomTrayMenuItem()
    {
        _customMenuItemCount++;
        var itemNumber = _customMenuItemCount;

        TrayService.AddTrayMenuItem(
            CheapAvaloniaBlazor.Models.TrayMenuItemDefinition.Create(
                $"Custom Item {itemNumber}",
                () => Snackbar.Add($"Custom menu item {itemNumber} clicked!", Severity.Success),
                $"custom_{itemNumber}"));

        Snackbar.Add($"Added 'Custom Item {itemNumber}' to tray menu", Severity.Info);
    }

    private void ClearCustomTrayMenuItems()
    {
        TrayService.ClearTrayMenu();
        _customMenuItemCount = 0;
        Snackbar.Add("Custom tray menu items cleared", Severity.Warning);
    }
}
