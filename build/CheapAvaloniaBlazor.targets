<!-- build/CheapAvaloniaBlazor.targets -->
<Project>
  <Target Name="CheapAvaloniaBlazorCheck" BeforeTargets="Build">
    <Message Text="CheapAvaloniaBlazor: Configuring Blazor desktop application..." Importance="high" />
  </Target>

  <!--
    .NET 10+: Copy Blazor framework file (blazor.web.js) to output wwwroot.
    In .NET 10, these files are no longer embedded in assemblies - they're static web assets
    that must be served from the file system. For embedded Blazor scenarios (desktop apps),
    UseStaticFiles() serves them from wwwroot/_framework/.
  -->
  <Target Name="CopyBlazorFrameworkFilesFromLibrary" AfterTargets="Build" Condition="'$(TargetFramework)' != '' AND $([MSBuild]::VersionGreaterThanOrEquals('$(TargetFrameworkVersion)', '10.0'))">
    <PropertyGroup>
      <!-- Try to find the internal assets package - match the major.minor version -->
      <BlazorInternalAssetsPattern>$(NuGetPackageRoot)microsoft.aspnetcore.app.internal.assets/$([System.Text.RegularExpressions.Regex]::Match('$(TargetFrameworkVersion)', '^\d+\.\d+').Value).*/_framework/</BlazorInternalAssetsPattern>
      <DestinationFrameworkPath>$(OutputPath)wwwroot/_framework/</DestinationFrameworkPath>
    </PropertyGroup>

    <!-- Find the actual path using wildcard -->
    <ItemGroup>
      <BlazorInternalAssetsDirs Include="$(NuGetPackageRoot)microsoft.aspnetcore.app.internal.assets/*/_framework/" />
      <BlazorInternalAssetsDirsSorted Include="@(BlazorInternalAssetsDirs)" Condition="$([System.String]::new('%(Identity)').Contains('$([System.Text.RegularExpressions.Regex]::Match($(TargetFrameworkVersion), ^\d+\.\d+).Value)'))" />
    </ItemGroup>

    <!-- Use the latest matching version's files -->
    <PropertyGroup>
      <BlazorAssetsPath>@(BlazorInternalAssetsDirs->Reverse()->GetPathsOfAllDirectoriesAbove())</BlazorAssetsPath>
    </PropertyGroup>

    <ItemGroup>
      <BlazorFrameworkFiles Include="$(NuGetPackageRoot)microsoft.aspnetcore.app.internal.assets/**/_framework/blazor.web.js" />
    </ItemGroup>

    <Message Text="CheapAvaloniaBlazor: Looking for Blazor framework files..." Importance="normal" Condition="'@(BlazorFrameworkFiles)' != ''" />
    <MakeDir Directories="$(DestinationFrameworkPath)" Condition="'@(BlazorFrameworkFiles)' != ''" />

    <!-- Copy only the first match (latest version) for each file -->
    <Copy SourceFiles="@(BlazorFrameworkFiles)"
          DestinationFolder="$(DestinationFrameworkPath)"
          SkipUnchangedFiles="true"
          Condition="'@(BlazorFrameworkFiles)' != ''" />

    <Message Text="CheapAvaloniaBlazor: Copied Blazor framework files to $(DestinationFrameworkPath)" Importance="high" Condition="'@(BlazorFrameworkFiles)' != ''" />
    <!-- Not a hard failure: UseStaticWebAssets() in EmbeddedBlazorHostService serves blazor.web.js
         from the NuGet cache at runtime (Development environment). dotnet publish handles it for deployments.
         This copy is a convenience for running from build output directly. Common cause: dotnet build --no-restore
         on a fresh CI runner where Microsoft.AspNetCore.App.Internal.Assets hasn't been restored yet. -->
    <Warning Text="CheapAvaloniaBlazor: blazor.web.js not found in NuGet cache (Microsoft.AspNetCore.App.Internal.Assets). Run 'dotnet restore' first, or the app will rely on UseStaticWebAssets() to serve it at runtime." Condition="'@(BlazorFrameworkFiles)' == ''" />
  </Target>

  <!-- Only create wwwroot if it doesn't exist, no copying -->
  <Target Name="EnsureWwwrootExists" BeforeTargets="Build" Condition="!Exists('$(MSBuildProjectDirectory)\wwwroot')">
    <PropertyGroup>
      <WwwRootPath>$(MSBuildProjectDirectory)\wwwroot</WwwRootPath>
    </PropertyGroup>

    <MakeDir Directories="$(WwwRootPath)" />

    <!-- Create minimal favicon to prevent 404s -->
    <WriteLinesToFile
      File="$(WwwRootPath)\favicon.ico"
      Lines=""
      Overwrite="false" />

    <Message Text="CheapAvaloniaBlazor: Created minimal wwwroot folder" Importance="normal" />
  </Target>

  <!-- Import Razor SDK targets if not already imported -->
  <Import Project="$(MSBuildExtensionsPath)\Microsoft\Microsoft.NET.Sdk.Razor\build\netstandard2.0\Microsoft.NET.Sdk.Razor.targets"
          Condition="'$(UsingMicrosoftNETSdkRazor)' != 'true' and Exists('$(MSBuildExtensionsPath)\Microsoft\Microsoft.NET.Sdk.Razor\build\netstandard2.0\Microsoft.NET.Sdk.Razor.targets')" />
</Project>