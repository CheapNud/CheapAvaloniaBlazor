<!-- build/CheapAvaloniaBlazor.targets -->
<Project>
  <Target Name="CheapAvaloniaBlazorCheck" BeforeTargets="Build">
    <Message Text="CheapAvaloniaBlazor: Configuring Blazor desktop application..." Importance="high" />
  </Target>

  <Target Name="EnsureWwwrootExists" BeforeTargets="Build">
    <PropertyGroup>
      <WwwRootPath Condition="'$(WwwRootPath)' == ''">$(MSBuildProjectDirectory)\wwwroot</WwwRootPath>
    </PropertyGroup>
    
    <MakeDir Directories="$(WwwRootPath)" Condition="!Exists('$(WwwRootPath)')" />
    
    <!-- Create default favicon if missing -->
    <WriteLinesToFile
      File="$(WwwRootPath)\favicon.ico"
      Lines=""
      Condition="!Exists('$(WwwRootPath)\favicon.ico')"
      Overwrite="true" />
  </Target>

  <Target Name="EnsureImportsFile" BeforeTargets="Build">
    <!-- Ensure _Imports.razor exists in the consuming project -->
    <PropertyGroup>
      <ImportFilePath>$(MSBuildProjectDirectory)\_Imports.razor</ImportFilePath>
      <TemplateImportsPath>$(MSBuildThisFileDirectory)..\content\_Imports.razor</TemplateImportsPath>
    </PropertyGroup>
    
    <!-- Copy template _Imports.razor if it doesn't exist -->
    <Copy 
      SourceFiles="$(TemplateImportsPath)" 
      DestinationFiles="$(ImportFilePath)" 
      Condition="!Exists('$(ImportFilePath)') AND Exists('$(TemplateImportsPath)')" 
      SkipUnchangedFiles="true" />
      
    <Message Text="CheapAvaloniaBlazor: Created _Imports.razor from template" Importance="normal" 
             Condition="!Exists('$(ImportFilePath)') AND Exists('$(TemplateImportsPath)')" />
  </Target>

  <Target Name="CopyBlazorAssets" AfterTargets="Build">
    <!-- Copy embedded JavaScript interop file -->
    <Message Text="Copying CheapAvaloniaBlazor assets..." Importance="normal" />
    
    <PropertyGroup>
      <WwwRootPath Condition="'$(WwwRootPath)' == ''">$(MSBuildProjectDirectory)\wwwroot</WwwRootPath>
      <BlazorInteropSource>$(MSBuildThisFileDirectory)..\Resources\wwwroot\cheap-blazor-interop.js</BlazorInteropSource>
    </PropertyGroup>
    
    <!-- Ensure wwwroot exists -->
    <MakeDir Directories="$(WwwRootPath)" Condition="!Exists('$(WwwRootPath)')" />
    
    <!-- Copy JavaScript interop file from package resources -->
    <Copy 
      SourceFiles="$(BlazorInteropSource)" 
      DestinationFiles="$(WwwRootPath)\cheap-blazor-interop.js" 
      Condition="Exists('$(BlazorInteropSource)')" 
      SkipUnchangedFiles="true" />
      
    <!-- Copy any additional package assets -->
    <ItemGroup>
      <CheapAvaloniaBlazorAssets Include="$(MSBuildThisFileDirectory)..\Resources\wwwroot\**\*" />
    </ItemGroup>
    
    <Copy 
      SourceFiles="@(CheapAvaloniaBlazorAssets)" 
      DestinationFiles="@(CheapAvaloniaBlazorAssets->'$(WwwRootPath)\%(RecursiveDir)%(Filename)%(Extension)')" 
      SkipUnchangedFiles="true" 
      Condition="@(CheapAvaloniaBlazorAssets->Count()) > 0" />
      
    <Message Text="CheapAvaloniaBlazor: Assets copied to $(WwwRootPath)" Importance="normal" />
  </Target>
</Project>